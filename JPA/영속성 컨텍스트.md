# 영속성 컨텍스트



### 영속성 컨텍스트란?

먼저 영속성은 뭘까? 데이터를 생성한 프로그램의 실행이 종료되더라도 **사라지지 않는 데이터**의 특성을 의미한다. 영속성을 갖지 않는 데이터는 단지 메모리에서만 존재하기 때문에 프로그램을 종료하면 모두 잃어버리게 된다.

컨텍스트란? Bean의 확장판. Bean은 스프링에서 객체를 관리하는 객체. Bean을 다루기 위한 Container라는 공간 안의 Context라는 공간이 있는 것. 다시 정리 해보자면, Context란 **Bean들을 다루기 위해 우리가 설정할 수 있는 공간**이다.

> Bean은 이제 전등을 끼우는 것과 같다고 보면 된다. 전등 자체만 보면 불을 킬수가 없지만, 천장에 전등을 끼우면 불을 껐다 켰다 관리할 수 있듯이, Bean에 등록하지 않은 객체는 관리할 수 없지만, Bean에 등록한 객체는 Container가 관리할 수 있다.



JPA를 이해하는데 가장 중요한 용어로, **Entity를 영구 저장하는 환경**이라는 뜻이다. 애플리케이션과 데이터베이스 사이에서 객체를 보관하는 가상의 데이터베이스 같은 역할을 한다. 엔티티매니저를 통해 엔티티를 저장하거나 조회하면 매니저는 영속성 컨텍스트에 엔티티를 보관하고 관리한다. 

> Spring Data JPA에서는 서버 구동될 때 알아서 EntityManager가 만들어진다(ORM이 잘못되거나 하면 에러 로그 EntityManager에서 나옴). 즉, Repository를 통해서 영속성 컨텍스트에 올리고 한다고 생각하면 될 듯 하다.

<img src="https://suhwan.dev/images/jpa_hibernate_repository/overall_design.png" alt="image info" style="zoom:33%;" />



> `.persist()`함수를 통해 영속성 컨텍스트에 저장하는데, 우리는 Repository를 통해서 하니까 .save()라고 생각하면 될 듯 하다



영속성 컨텍스트의 특징은 다음과 같다.

1. 엔티티 매니저를 생성할 때 하나 만들어진다.
2. 엔티티 매니저를 통해서 영속성 컨텍스트에 접근하고 관리할 수 있다.



### 엔티티의 생명주기

+ 비영속

  엔티티 객체를 생성했지만 아직 영속성 컨텍스트에 저장하지 않은 상태

+ 영속

  엔티티 매니저를 통해서 엔티티를 영속성 컨텍스트에 저장한 상태를 말하며 영속성 컨텍스트에 의해 관리됨

+ 준영속

  영속성 컨텍스트가 관리하던 영속 상태의 엔티티를 더이상 관리하지 않으면 준영속 상태가 된다. 

  -> 웬만하면 거의 쓰는 일이 없다고 함.

+ 삭제

  엔티티를 영속성 컨텍스트와 데이터베이스에서 삭제한다



### 영속성 컨텍스트의 특징

+ 영속성 컨텍스트의 식별자 값

  영속성 컨텍스트는 엔티티를 식별자(기본키와 매핑된 필드) 값으로 구분하기 때문에, 영속 상태는 식별자(@Id) 값이 반드시 있어야 한다. 없으면 예외가 발생한다.

  > PK가 없는 엔티티가 있는 경우도 있는데, 이런경우는 보통 종속적인 관계에 있을 때이다. 이 종속적인 엔티티는 고유해야할 필요가 없기 때문에 PK가 있을 필요가 없고, 얘는 PK 없어도 영속성 컨텍스트에 올라갈 수 있다. (따로 구분하려면 엔티티를 따로 파야 한다)

+ 영속성 컨텍스트와 데이터베이스 저장

  JPA는 보통 트랜잭션을 커밋하는 순간 영속성 컨텍스트에 변경된 엔티티를 데이터베이스에 반영하는데, 이를 `flush`라 한다.

  > flush는 flush() 메소드 호출시, 트랜잭션 종료시 etc에 일어난다.



___



영속성이란, 사라지지 않는 데이터의 특성을 말한다(다음에도 쓸 수 있는 데이터가 되는 것이다). 컨텍스트란 bean들을 관리하는 창고라고 생각하면 될 듯하다.



영속성 컨텍스트에 올린다는 것은 entity를 보관하고 관리할 수 있도록 한다는 것이다. 

영속성 컨텍스트의 생명주기는 비영속/영속/준영속/삭제로 나뉘는데, 비영속은 엔티티의 객체만 생성한 것이고 영속은 `.save()`등을 사용하여 컨텍스트에 올린것이다.



영속성 컨텍스트에 올리려면 식별자가 반드시 있어야한다. 영속성 컨텍스트에 변경된 엔티티를 데이터베이스에 반영하는 것을 flush라고 한다.